<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Mall DApp - Telegram MiniApp</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    nav { display: flex; background: #fff; border-bottom: 1px solid #ddd; }
    nav button { flex: 1; padding: 1rem; background: none; border: none; cursor: pointer; font-size: 1rem; }
    nav button.active { border-bottom: 2px solid #007aff; color: #007aff; }
    section { display: none; padding: 1rem; }
    section.show { display: block; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-content { background: #fff; padding: 1rem; border-radius: 8px; width: 90%; max-width: 400px; }
    button { background: #007aff; color: #fff; border: none; padding: 0.75rem 1rem; font-size: 1rem; border-radius: 4px; cursor: pointer; }
    button.secondary { background: #ccc; color: #333; margin-left: 0.5rem; }
    input[type="date"], input[type="number"] { width: 100%; padding: 0.5rem; margin: 0.5rem 0; font-size: 1rem; }
    ul { list-style: none; padding: 0; }
    ul li { background: #fff; margin-bottom: 0.5rem; padding: 0.75rem; border-radius: 4px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <nav>
    <button id="nav-register" class="active">📝 Đăng ký</button>
    <button id="nav-wallet">💰 Ví</button>
    <button id="nav-history">🔍 Lịch sử</button>
  </nav>

  <section id="register" class="show">
    <h2>Đăng ký phiên</h2>
    <input type="date" id="sessionDate" />
    <button id="openRegisterModal">Đăng ký</button>
  </section>

  <section id="wallet">
    <h2>Ví của bạn</h2>
    <p>Số dư: <strong><span id="walletBalance">0</span> VND</strong></p>
    <p>Cần: <strong><span id="requiredUSDT">0</span> USDT</strong></p>
    <input type="number" id="depositSMP" placeholder="Nhập số SMP" />
  </section>

  <section id="history">
    <h2>Lịch sử giao dịch</h2>
    <ul id="historyList">
      <!-- Các giao dịch sẽ được render tại đây -->
    </ul>
  </section>

  <div id="registerModal" class="modal">
    <div class="modal-content">
      <h3>Xác nhận đăng ký</h3>
      <p>Phiên ngày: <strong><span id="modalDate"></span></strong></p>
      <div style="text-align: right; margin-top: 1rem;">
        <button id="confirmRegisterBtn">Xác nhận</button>
        <button id="closeRegisterModal" class="secondary">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Supabase & Telegram SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Cấu hình Supabase
    const SUPA_URL = 'https://tntvuqpmcfzqvvqwdihu.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRudHZ1cXBtY2Z6cXZ2cXdkaWh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMDY4OTksImV4cCI6MjA2NzY4Mjg5OX0.QUOf8t1BHA6MnokLsUQ_VNdztIzyeyO5jknitP-1mzE';
    const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    // Khởi tạo Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.text = 'Xác nhận';

    // Xác định user
    const userId = 'tg_' + tg.initDataUnsafe.user.id;

    // Hiển thị section
    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('show'));
      document.getElementById(id).classList.add('show');
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      document.getElementById('nav-' + id).classList.add('active');
      tg.MainButton.hide();
    }

    // Load số dư ví
    async function loadWallet() {
      const { data } = await supabase
        .from('wallets')
        .select('balance')
        .eq('user_id', userId)
        .single();
      const balance = data?.balance || 0;
      document.getElementById('walletBalance').innerText = balance.toLocaleString('vi-VN');
    }

    // Load lịch sử giao dịch
    async function loadHistory() {
      const { data } = await supabase
        .from('history')
        .select('type, amount, time, meta')
        .eq('user_id', userId)
        .order('time', { ascending: false });
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.innerText = `${item.type}: ${item.amount > 0 ? '+' : ''}${item.amount.toLocaleString('vi-VN')} VND — ${new Date(item.time).toLocaleString()}`;
        list.appendChild(li);
      });
    }

    // Sự kiện mở modal đăng ký
    document.getElementById('openRegisterModal').addEventListener('click', () => {
      const date = document.getElementById('sessionDate').value;
      if (!date) return alert('Vui lòng chọn ngày');
      document.getElementById('modalDate').innerText = date;
      document.getElementById('registerModal').classList.add('show');
      tg.MainButton.show();
    });

    // Sự kiện đóng modal
    document.getElementById('closeRegisterModal').addEventListener('click', () => {
      document.getElementById('registerModal').classList.remove('show');
      tg.MainButton.hide();
    });

    // Xác nhận đăng ký qua Telegram MainButton
    tg.MainButton.onClick(async () => {
      const date = document.getElementById('sessionDate').value;
      if (!date) return;</n      // Cập nhật database
      await supabase
        .from('wallets')
        .upsert({ user_id: userId, balance: supabase.raw('balance - 20000') }, { onConflict: 'user_id' });
      await supabase
        .from('history')
        .insert([{ user_id: userId, type: 'Phí đăng ký phiên', amount: -20000, meta: { date } }]);
      // Cập nhật giao diện
      await loadWallet();
      await loadHistory();
      alert('Đăng ký thành công phiên ' + date);
      document.getElementById('registerModal').classList.remove('show');
      tg.MainButton.hide();
    });

    // Quản lý điều hướng
    document.getElementById('nav-register').addEventListener('click', () => showSection('register'));
    document.getElementById('nav-wallet').addEventListener('click', async () => { showSection('wallet'); await loadWallet(); });
    document.getElementById('nav-history').addEventListener('click', async () => { showSection('history'); await loadHistory(); });

    // Tính USDT khi nhập SMP
    document.getElementById('depositSMP').addEventListener('input', e => {
      const v = parseFloat(e.target.value) || 0;
      document.getElementById('requiredUSDT').innerText = (v / 23000).toFixed(4);
    });

    // Khởi tạo dữ liệu
    loadWallet();
    loadHistory();
  </script>
</body>
</html>
