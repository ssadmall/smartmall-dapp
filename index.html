<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Mall DApp</title>
  <style>
    body { background:#0a1a2f; color:#fff; font-family:Arial, sans-serif; margin:0; padding-bottom:100px; }
    section { display:none; padding:20px; margin:10px; background:#162447; border:2px solid #21e6c1; border-radius:8px; }
    section.active { display:block; }
    h2 { margin-top:0; color:#21e6c1; }
    /* NAVIGATION */
    nav {
      position:fixed; bottom:0; left:0; right:0;
      display:flex; background:#162447; border-top:2px solid #21e6c1; z-index:999;
    }
    nav button {
      flex:1; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      padding:8px 0; font-size:14px; line-height:1.2;
      background:#162447; color:#fff; border:none; cursor:pointer;
    }
    nav button .nav-icon { font-size:20px; margin-bottom:2px; }
    nav button.active, nav button:hover {
      background:#21e6c1; color:#162447;
    }
    /* GENERAL */
    button, input { border:none; border-radius:4px; }
    button { background:#21e6c1; color:#0a1a2c; font-weight:bold; cursor:pointer; margin:6px 0; padding:8px; width:100%; }
    button.small { display:inline-block; width:auto; margin:4px 2px; padding:6px 12px; }
    input { width:100%; padding:8px; margin:6px 0; background:#1f4068; color:#fff; }
    .date-tab-bar { display:flex; justify-content:space-between; background:#1b2c45; padding:6px; border-radius:8px; margin:12px 0; }
    .date-tab-bar button { flex:1; margin:0 2px; padding:6px 4px; background:#0f1c2e; color:#ccc; font-size:13px; cursor:pointer; border:none; border-radius:6px; }
    .date-tab-bar button.active { background:#21e6c1; color:#162447; font-weight:bold; }
    .product, .nft-item, .sale-item { background:#1f4068; border:1px solid #21e6c1; border-radius:6px; padding:10px; margin-bottom:10px; }
    .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-content { background:#fff; color:#000; padding:20px; border-radius:8px; width:300px; }
    #walletAction { margin-top:10px; }
    #walletHistory { margin-top:20px; max-height:200px; overflow-y:auto; }
    #walletHistory div { padding:6px 0; font-size:14px; }
    .pos { color:#4caf50; }
    .neg { color:#f44336; }
    #referralSection a { word-break:break-all; color:#ffcc00; }
  </style>
</head>
<body>

  <!-- Home -->
  <section id="home" class="active">
    <h2>üì¢ Th√¥ng b√°o t·ª´ Admin</h2>
    <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Smart Mall - Giao d·ªãch th√¥ng minh, c·ªông ƒë·ªìng b·ªÅn v·ªØng!</p>
  </section>

  <!-- Session -->
  <section id="session">
    <h2>üïí Phi√™n giao d·ªãch</h2>
    <div class="date-tab-bar" id="sessionDateTabs"></div>
    <p>Ng√†y phi√™n ƒë√£ ch·ªçn: <b id="selectedDateText"></b></p>
    <div id="registrationBox">
      <button id="registerBtn" onclick="showRegisterModal()">ƒêƒÉng k√Ω phi√™n</button>
    </div>
    <div id="joinContainer" style="display:none">
      <button id="joinBtn" class="small" onclick="joinSession()">Tham gia phi√™n</button>
    </div>
    <div id="products" style="display:none">
      <h3>S·∫£n ph·∫©m phi√™n h√¥m nay</h3><div id="productList"></div>
      <h3>S·∫£n ph·∫©m treo b√°n</h3><div id="pendingSaleList"></div>
    </div>
  </section>

  <!-- NFT -->
  <section id="nft">
    <h2>üßæ NFT c·ªßa t√¥i</h2>
    <div id="nftList"></div>
    <p>T·ªïng chi ti√™u: <span id="totalSpent">0</span> USDT</p>
  </section>

  <!-- Wallet -->
  <section id="wallet">
    <h2>üí∞ V√≠ SML</h2>
    <p>S·ªë d∆∞: <span id="walletBalance">100000</span> SML</p>
    <button onclick="showDeposit()">N·∫°p</button>
    <button onclick="showTransfer()">Chuy·ªÉn</button>
    <button onclick="showWithdraw()">R√∫t</button>
    <div id="walletAction"></div>
    <h3>L·ªãch s·ª≠ SML</h3><div id="walletHistory">Ch∆∞a c√≥ giao d·ªãch</div>
  </section>

  <!-- Profile -->
  <section id="profile">
    <h2>üë§ Th√¥ng tin c√° nh√¢n</h2>
    <input id="username" placeholder="T√™n (vi·∫øt li·ªÅn)"/>
    <input id="phone"    placeholder="S·ªë ƒëi·ªán tho·∫°i"/>
    <input id="fullname" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß"/>
    <input id="bep20"    placeholder="ƒê·ªãa ch·ªâ v√≠ BEP20"/>
    <button onclick="saveProfile()">L∆∞u th√¥ng tin</button>

    <!-- Referral -->
    <div id="referralSection" style="margin-top:20px; padding-top:10px; border-top:1px solid #21e6c1;">
      <h3>üîó Link gi·ªõi thi·ªáu</h3>
      <p><a href="#" id="referralLink" target="_blank"></a></p>
      <p>üë• Gi·ªõi thi·ªáu tr·ª±c ti·∫øp: <span id="directRefCount">0</span></p>
      <p>üåê ƒê·ªôi nh√≥m: <span id="teamRefCount">0</span></p>
    </div>
  </section>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <h3>Ph√≠ ƒëƒÉng k√Ω: 20 000 SML</h3>
      <input type="number" id="registerAmount" placeholder="S·ªë ti·ªÅn d·ª± ki·∫øn mua"/>
      <button onclick="confirmRegister()">X√°c nh·∫≠n</button>
      <button onclick="closeRegisterModal()">H·ªßy</button>
    </div>
  </div>

  <!-- Navigation Bar -->
  <nav>
    <button id="btn-home"    class="active" onclick="showSection('home')">
      <span class="nav-icon">üè†</span>
      <span>Trang ch·ªß</span>
    </button>
    <button id="btn-session" onclick="showSection('session')">
      <span class="nav-icon">üïí</span>
      <span>Phi√™n</span>
    </button>
    <button id="btn-nft"     onclick="showSection('nft')">
      <span class="nav-icon">üßæ</span>
      <span>NFT</span>
    </button>
    <button id="btn-wallet"  onclick="showSection('wallet')">
      <span class="nav-icon">üí∞</span>
      <span>V√≠</span>
    </button>
    <button id="btn-profile" onclick="showSection('profile')">
      <span class="nav-icon">üë§</span>
      <span>Th√¥ng tin</span>
    </button>
  </nav>

  <script>
    // L·∫•y referral link, m·∫∑c ƒë·ªãnh guest n·∫øu kh√¥ng trong Telegram WebApp
    let userId = 'guest';
    if (window.Telegram?.WebApp) {
      const tg = window.Telegram.WebApp;
      tg.ready();
      userId = tg.initDataUnsafe?.user?.id ?? 'guest';
    }
    const referralLink = `https://t.me/SmartMallonebot?start=${userId}`;

    // State
    let walletBalance=100000, registerFee=20000, registeredFee=false;
    let selectedDate=null, totalSpent=0;
    let products=[
      {id:'012345678901234567890123',name:'Tai nghe Bluetooth',price:50000,seller:'Admin'},
      {id:'123456789012345678901234',name:'Qu·∫°t mini USB',price:30000,seller:'Admin'},
      {id:'234567890123456789012345',name:'ƒê√®n h·ªçc c·∫£m ·ª©ng',price:45000,seller:'Admin'}
    ];
    let userNFT=[], pendingSales=[], walletHistory=[];

    // Utils
    function fmt(n){ return n.toLocaleString('vi-VN'); }
    function updateWallet(){ document.getElementById('walletBalance').innerText = fmt(walletBalance); }
    function addHistory(desc,delta){
      walletHistory.unshift({desc,delta,time:new Date().toLocaleString('vi-VN')});
      renderHistory();
    }
    function renderHistory(){
      const h=document.getElementById('walletHistory');
      if(!walletHistory.length) return h.innerText='Ch∆∞a c√≥ giao d·ªãch';
      h.innerHTML = walletHistory.map(x=>`
        <div>[${x.time}] 
          <span class="${x.delta<0?'neg':'pos'}">
            ${x.delta>0?'+':''}${fmt(Math.abs(x.delta))}
          </span> SML ‚Äì ${x.desc}
        </div>`).join('');
    }

    // Section switch
    function showSection(id){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
      document.getElementById('btn-'+id).classList.add('active');
    }

    // Session tabs
    function generateTabs(){
      const c=document.getElementById('sessionDateTabs'),
            txt=document.getElementById('selectedDateText'),
            today=new Date();
      for(let i=0;i<7;i++){
        const d=new Date(today); d.setDate(d.getDate()+i);
        const lbl=`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
        const btn=document.createElement('button');
        btn.textContent=lbl;
        btn.onclick=()=>{
          document.querySelectorAll('.date-tab-bar button').forEach(x=>x.classList.remove('active'));
          btn.classList.add('active'); selectedDate=lbl; txt.innerText=lbl;
        };
        if(i===0){ btn.classList.add('active'); selectedDate=lbl; txt.innerText=lbl; }
        c.appendChild(btn);
      }
    }

    // Registration modal
    function showRegisterModal(){
      if(walletBalance<registerFee) return alert('Kh√¥ng ƒë·ªß SML!');
      document.getElementById('registerModal').style.display='flex';
    }
    function closeRegisterModal(){
      document.getElementById('registerModal').style.display='none';
    }
    function confirmRegister(){
      const amt=parseFloat(document.getElementById('registerAmount').value);
      if(isNaN(amt)||amt<=0) return alert('Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!');
      walletBalance-=registerFee; updateWallet(); addHistory('Ph√≠ ƒëƒÉng k√Ω phi√™n',-registerFee);
      registeredFee=true; closeRegisterModal();
      document.getElementById('registrationBox').innerHTML=`<p>ƒê√£ ƒëƒÉng k√Ω: ${fmt(amt)}</p>`;
      document.getElementById('joinContainer').style.display='block';
    }

    // Join session
    function joinSession(){
      if(registeredFee){
        walletBalance+=registerFee; updateWallet(); addHistory('Ho√†n ph√≠ ƒëƒÉng k√Ω',+registerFee);
        registeredFee=false;
      }
      document.getElementById('products').style.display='block';
      renderProducts(); renderPendingSales();
    }

    // Products
    function renderProducts(){
      const list=document.getElementById('productList'); list.innerHTML='';
      products.forEach(p=>{
        list.innerHTML+=`
          <div class="product">
            <b>${p.name}</b><br>ID: ${p.id}<br>Gi√°: ${fmt(p.price)}<br>
            <button class="small" onclick="buyProduct('${p.id}')">Mua</button>
          </div>`;
      });
    }
    function buyProduct(id){
      const p=products.find(x=>x.id===id); if(!p)return;
      userNFT.push({...p,status:'bought'}); products=products.filter(x=>x.id!==id);
      renderProducts(); renderNFTs();
    }

    // Pending sales
    function renderPendingSales(){
      const list=document.getElementById('pendingSaleList'); list.innerHTML='';
      if(!selectedDate) return;
      pendingSales.filter(s=>s.sellDate===selectedDate)
        .forEach(s=>{
          list.innerHTML+=`
            <div class="sale-item">
              <b>${s.name}</b><br>ID: ${s.id}<br>
              Gi√° b√°n: ${fmt(s.salePrice)}<br>
              Ph√≠: ${fmt(s.saleFee)}<br>
              <button class="small" onclick="buyPendingSale('${s.id}')">Mua</button>
            </div>`;
        });
    }
    function buyPendingSale(id){
      const idx=pendingSales.findIndex(x=>x.id===id); if(idx<0)return;
      const s=pendingSales[idx];
      if(walletBalance<s.salePrice) return alert('Kh√¥ng ƒë·ªß SML!');
      walletBalance-=s.salePrice; updateWallet(); addHistory(`Mua ${s.name}`,-s.salePrice);
      userNFT.push({...s,status:'bought'}); pendingSales.splice(idx,1);
      renderPendingSales(); renderNFTs();
    }

    // NFT
    function renderNFTs(){
      const c=document.getElementById('nftList'); c.innerHTML=''; let tot=0;
      if(!userNFT.length) return c.innerText='Ch∆∞a c√≥ s·∫£n ph·∫©m.';
      userNFT.forEach(it=>{
        tot+=it.price;
        let html=`<div class="nft-item"><b>${it.name}</b><br>ID: ${it.id}<br>`;
        if(it.status==='bought') html+=`<button class="small" onclick="markPaid('${it.id}')">ƒê√£ thanh to√°n</button>`;
        else if(it.status==='owned') html+=`<button class="small" onclick="openNFT('${it.id}')">M·ªü</button>
                                             <button class="small" onclick="sellNFT('${it.id}')">B√°n</button>`;
        html+='</div>';
        c.innerHTML+=html;
      });
      document.getElementById('totalSpent').innerText=fmt(tot);
    }
    function markPaid(id){
      const it=userNFT.find(x=>x.id===id); if(!it||walletBalance<it.price)return alert('Kh√¥ng ƒë·ªß SML!');
      walletBalance-=it.price; updateWallet(); addHistory('Thanh to√°n',-it.price);
      it.status='owned'; renderNFTs();
    }
    function openNFT(id){
      const it=userNFT.find(x=>x.id===id); if(!it)return;
      const rf=it.price*0.9; walletBalance+=rf; updateWallet(); addHistory('Ho√†n NFT',rf);
      it.status='opened'; renderNFTs(); alert(`B·∫°n nh·∫≠n ${fmt(rf)} SML`);
    }
    function sellNFT(id){
      const it=userNFT.find(x=>x.id===id); if(!it)return;
      const profit=it.price*0.015, fee=it.price*0.034, salePrice=it.price+profit+fee;
      if(walletBalance<fee) return alert('Kh√¥ng ƒë·ªß SML tr·∫£ ph√≠!');
      walletBalance-=fee; updateWallet(); addHistory('Ph√≠ g·ª≠i b√°n',-fee);
      it.status='pendingSale'; it.salePrice=salePrice;
      const tm=new Date(); tm.setDate(tm.getDate()+1);
      it.sellDate=new Intl.DateTimeFormat('vi-VN',{day:'2-digit',month:'2-digit'}).format(tm);
      pendingSales.push({...it}); renderNFTs(); renderPendingSales();
    }

    // Wallet
    function showDeposit(){ document.getElementById('walletAction').innerHTML=`
      <h3>N·∫°p SML</h3><input type="number" id="depositAmt" placeholder="S·ªë SML"/>
      <button onclick="confirmDeposit()">X√°c nh·∫≠n</button>`; }
    function confirmDeposit(){
      const amt=parseFloat(document.getElementById('depositAmt').value);
      if(isNaN(amt)||amt<=0)return alert('Nh·∫≠p s·ªë h·ª£p l·ªá!');
      walletBalance+=amt; updateWallet(); addHistory('N·∫°p SML',amt);
      document.getElementById('walletAction').innerHTML='';
    }
    function showTransfer(){ document.getElementById('walletAction').innerHTML=`
      <h3>Chuy·ªÉn SML</h3><input id="transferTo" placeholder="Ng∆∞·ªùi nh·∫≠n"/>
      <input id="transferAmt" placeholder="S·ªë SML"/><button onclick="confirmTransfer()">X√°c nh·∫≠n</button>`; }
    function confirmTransfer(){
      const to=document.getElementById('transferTo').value.trim(),
            amt=parseFloat(document.getElementById('transferAmt').value);
      if(!to||isNaN(amt)||amt<=0)return alert('Nh·∫≠p ƒë√∫ng th√¥ng tin!');
      if(walletBalance<amt)return alert('Kh√¥ng ƒë·ªß SML!');
      walletBalance-=amt; updateWallet(); addHistory(`Chuy·ªÉn cho ${to}`,-amt);
      document.getElementById('walletAction').innerHTML='';
    }
    function showWithdraw(){ document.getElementById('walletAction').innerHTML=`
      <h3>R√∫t SML</h3><input id="withdrawAddr" placeholder="ƒê·ªãa ch·ªâ BEP20"/>
      <input id="withdrawAmt" placeholder="S·ªë SML"/><p>Ph√≠ 1.5%</p>
      <button onclick="confirmWithdraw()">X√°c nh·∫≠n</button>`; }
    function confirmWithdraw(){
      const addr=document.getElementById('withdrawAddr').value.trim(),
            amt=parseFloat(document.getElementById('withdrawAmt').value);
      if(!addr||isNaN(amt)||amt<=0)return alert('Nh·∫≠p ƒë√∫ng th√¥ng tin!');
      const fee=amt*0.015, total=amt+fee;
      if(walletBalance<total)return alert('Kh√¥ng ƒë·ªß SML!');
      walletBalance-=total; updateWallet(); addHistory(`R√∫t ${fmt(amt)} (+ ph√≠ ${fmt(fee)})`,-total);
      document.getElementById('walletAction').innerHTML='';
    }

    function saveProfile(){ alert('Th√¥ng tin c√° nh√¢n ƒë√£ l∆∞u.'); }

    // INIT
    window.onload = () => {
      generateTabs();
      updateWallet();
      renderHistory();
      // Referral
      document.getElementById('referralLink').href = referralLink;
      document.getElementById('referralLink').innerText = referralLink;
    };
  </script>
</body>
</html>
