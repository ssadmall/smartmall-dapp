<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Mall DApp</title>
  <style>
    /* =========== CHUNG =========== */
    body {
      background: #0a1a2f;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding-bottom: 80px;
    }
    section {
      display: none;
      padding: 20px;
      margin: 10px;
      background: #162447;
      border: 2px solid #21e6c1;
      border-radius: 8px;
    }
    section.show { display: block; }
    h2 { color: #21e6c1; margin-top: 0; }
    button, input, code {
      border: none; border-radius: 4px;
    }
    button {
      background: #21e6c1;
      color: #0a1a2f;
      font-weight: bold;
      cursor: pointer;
      margin: 6px 0;
      padding: 8px;
      width: 100%;
    }
    button.small {
      width: auto; padding: 6px 12px; margin: 4px 2px;
    }
    input {
      width: 100%; padding: 8px; margin: 6px 0;
      background: #1f4068; color: #fff;
    }
    code {
      display: block; background: #1f4068;
      padding: 8px; margin: 8px 0;
      font-family: monospace;
    }

    /* ======= Marquee ƒë·ªông ======= */
    .marquee {
      overflow: hidden; white-space: nowrap;
      box-sizing: border-box;
      animation: marquee 12s linear infinite;
    }
    @keyframes marquee {
      0%   { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* ======= NAV ======= */
    nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      display: flex; background: #162447;
      border-top: 2px solid #21e6c1;
    }
    nav .nav-btn {
      flex: 1; padding: 8px 0; font-size: 14px;
      background: #162447; color: #fff;
      cursor: pointer; border: none;
    }
    nav .nav-btn.active,
    nav .nav-btn:hover {
      background: #21e6c1; color: #162447;
    }

    /* ======= Language selector ======= */
    #langSelect {
      position: fixed; top: 10px; right: 10px;
      background: #1f4068; color: #fff;
      padding: 4px 8px; border: none; border-radius: 4px;
      z-index: 1000;
    }

    /* ======= DATE TABS ======= */
    .date-tab-bar {
      display: flex; justify-content: space-between;
      background: #1b2c45; padding: 6px;
      border-radius: 8px; margin: 12px 0;
    }
    .date-tab-bar button {
      flex: 1; margin: 0 2px; padding: 6px 4px;
      background: #0f1c2e; color: #ccc;
      font-size: 13px; cursor: pointer; border: none;
    }
    .date-tab-bar button.active {
      background: #21e6c1; color: #162447;
      font-weight: bold;
    }

    /* ======= GRID ======= */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
      gap: 10px;
    }
    .product, .sale-item, .nft-item {
      padding: 10px; border-radius: 6px; color: #fff;
    }

    /* ======= MODAL ======= */
    .modal {
      display: none; position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    .modal.show { display: flex !important; }
    .modal-content {
      background: #fff; color: #000; padding: 20px;
      border-radius: 8px; width: 300px;
    }

    /* ======= TABLE ======= */
    table {
      width: 100%; border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #21e6c1; padding: 6px;
      font-size: 14px;
    }
    th { background: #1b2c45; }

    /* ======= POS/NEG ======= */
    .pos { color: #4caf50; }
    .neg { color: #f44336; }
  </style>
</head>
<body>

  <!-- Language selector -->
  <select id="langSelect">
    <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
    <option value="en">üá¨üáß English</option>
  </select>

  <!-- LOGIN -->
  <section id="login" class="show">
    <h2 data-i18n-key="login_title">üîë ƒêƒÉng nh·∫≠p</h2>
    <input id="usernameInput" data-i18n-key="login_input" placeholder="Nh·∫≠p username (vi·∫øt li·ªÅn)"/>
    <button id="loginBtn" data-i18n-key="login_button">Ti·∫øp t·ª•c</button>
  </section>

  <!-- APP -->
  <div id="app" style="display:none">

    <!-- NAV -->
    <nav>
      <button id="btn-home"    class="nav-btn" onclick="showSection('home')"    data-i18n-key="nav_home">üè† Trang ch·ªß</button>
      <button id="btn-session" class="nav-btn" onclick="showSection('session')" data-i18n-key="nav_session">‚è±Ô∏è Phi√™n</button>
      <button id="btn-nft"     class="nav-btn" onclick="showSection('nft')"     data-i18n-key="nav_nft">üßæ NFT</button>
      <button id="btn-wallet"  class="nav-btn" onclick="showSection('wallet')"  data-i18n-key="nav_wallet">üí∞ V√≠</button>
      <button id="btn-profile" class="nav-btn" onclick="showSection('profile')" data-i18n-key="nav_profile">üë§ Th√¥ng tin</button>
    </nav>

    <!-- HOME -->
    <section id="home">
      <h2 data-i18n-key="home_title">üì¢ Th√¥ng b√°o t·ª´ Admin</h2>
      <div class="marquee">
        <span id="admin-notice" data-i18n-key="home_notice">
          Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Smart Mall ‚Äì Giao d·ªãch th√¥ng minh, c·ªông ƒë·ªìng b·ªÅn v·ªØng!
        </span>
      </div>
    </section>

    <!-- SESSION -->
    <section id="session">
      <h2 data-i18n-key="session_title">üïí Phi√™n giao d·ªãch</h2>
      <div class="date-tab-bar" id="sessionDateTabs"></div>
      <p><span data-i18n-key="session_selected">Ng√†y phi√™n ƒë√£ ch·ªçn:</span> <b id="selectedDateText"></b></p>

      <div id="registrationBox">
        <button onclick="showRegisterModal()" data-i18n-key="session_register_btn">
          ƒêƒÉng k√Ω phi√™n (20 000 SML)
        </button>
      </div>
      <div id="joinContainer" style="display:none">
        <button class="small" onclick="joinSession()" data-i18n-key="session_join_btn">
          Tham gia phi√™n
        </button>
      </div>

      <div id="products" style="display:none">
        <h3 data-i18n-key="session_products_today">S·∫£n ph·∫©m phi√™n h√¥m nay</h3>
        <div id="productList" class="grid"></div>
        <h3 data-i18n-key="session_pending_sales">S·∫£n ph·∫©m treo b√°n</h3>
        <div id="pendingSaleList" class="grid"></div>
      </div>
    </section>

    <!-- NFT -->
    <section id="nft">
      <h2 data-i18n-key="nft_title">üßæ NFT c·ªßa t√¥i</h2>
      <div id="nftList">Ch∆∞a c√≥ s·∫£n ph·∫©m.</div>
      <p>
        <span data-i18n-key="nft_total_spent">T·ªïng chi ti√™u:</span>
        <span id="totalSpent">0</span> USDT
      </p>
      <h3 data-i18n-key="nft_history_title">L·ªãch s·ª≠ NFT</h3>
      <ul id="nftHistory">Ch∆∞a c√≥ l·ªãch s·ª≠.</ul>
    </section>

    <!-- WALLET -->
    <section id="wallet">
      <h2 data-i18n-key="wallet_title">üí∞ V√≠ SML</h2>
      <p>
        <span data-i18n-key="wallet_balance">S·ªë d∆∞:</span>
        <span id="walletBalance">100 000</span> SML
      </p>
      <div class="wallet-tabs">
        <button onclick="showDeposit()"   data-i18n-key="wallet_deposit">N·∫°p</button>
        <button onclick="showTransfer()"  data-i18n-key="wallet_transfer">Chuy·ªÉn</button>
        <button onclick="showWithdraw()"  data-i18n-key="wallet_withdraw">R√∫t</button>
      </div>
      <div id="walletAction"></div>

      <h3 data-i18n-key="wallet_tx_history">L·ªãch s·ª≠ giao d·ªãch</h3>
      <div id="walletHistory">Ch∆∞a c√≥ giao d·ªãch.</div>

      <h3 data-i18n-key="wallet_req_history">L·ªãch s·ª≠ y√™u c·∫ßu n·∫°p/r√∫t</h3>
      <table>
        <thead>
          <tr>
            <th data-i18n-key="req_type">Lo·∫°i</th>
            <th data-i18n-key="req_sml">SML</th>
            <th data-i18n-key="req_usdt">USDT c·∫ßn</th>
            <th data-i18n-key="req_addr">ƒê·ªãa ch·ªâ</th>
            <th data-i18n-key="req_time">Th·ªùi gian</th>
            <th data-i18n-key="req_status">Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody id="requestHistory"></tbody>
      </table>
    </section>

    <!-- PROFILE -->
    <section id="profile">
      <h2 data-i18n-key="profile_title">üë§ Th√¥ng tin c√° nh√¢n</h2>
      <p><span data-i18n-key="profile_username">Username:</span> <b id="profileUsername"></b></p>
      <input id="phone"    placeholder="S·ªë ƒëi·ªán tho·∫°i"/>
      <input id="fullname" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß"/>
      <input id="bep20"    placeholder="ƒê·ªãa ch·ªâ v√≠ BEP20"/>
      <button onclick="saveProfile()" data-i18n-key="profile_save">L∆∞u th√¥ng tin</button>
      <div id="referralSection">
        <h3 data-i18n-key="profile_referral">üîó Link gi·ªõi thi·ªáu</h3>
        <p><a href="#" id="referralLink" target="_blank"></a></p>
        <p><span data-i18n-key="profile_direct">Gi·ªõi thi·ªáu tr·ª±c ti·∫øp:</span> <span id="directRefCount">0</span></p>
        <p><span data-i18n-key="profile_team">ƒê·ªôi nh√≥m:</span> <span id="teamRefCount">0</span></p>
      </div>
    </section>

    <!-- MODALS -->
    <div class="modal" id="registerModal">
      <div class="modal-content">
        <h3 data-i18n-key="reg_modal_title">Ph√≠ ƒëƒÉng k√Ω: 20 000 SML</h3>
        <button onclick="confirmRegister()" data-i18n-key="reg_modal_confirm">X√°c nh·∫≠n</button>
        <button onclick="closeRegisterModal()" data-i18n-key="reg_modal_cancel">H·ªßy</button>
      </div>
    </div>

    <div class="modal" id="depositModal">
      <div class="modal-content">
        <h3 data-i18n-key="dep_modal_title">Chuy·ªÉn USDT BEP20 t·ªõi:</h3>
        <code id="depositAddress">0xYourBEP20AddressHere</code>
        <p><span data-i18n-key="dep_usdt_price">Gi√° USDT:</span> <span id="usdtPrice">26 400</span> VND</p>
        <input type="number" id="depositSML" placeholder="S·ªë SML mu·ªën n·∫°p"/>
        <p id="requiredUSDT">C·∫ßn chuy·ªÉn: 0 USDT</p>
        <button onclick="submitDeposit()" data-i18n-key="dep_modal_confirm">X√°c nh·∫≠n n·∫°p</button>
        <button onclick="closeDepositModal()"  data-i18n-key="dep_modal_cancel">H·ªßy</button>
      </div>
    </div>

    <div class="modal" id="withdrawModal">
      <div class="modal-content">
        <h3 data-i18n-key="wd_modal_title">R√∫t SML (min 1 000 000)</h3>
        <input type="number" id="withdrawAmt" placeholder="S·ªë SML r√∫t"/>
        <button onclick="submitWithdraw()" data-i18n-key="wd_modal_confirm">X√°c nh·∫≠n r√∫t</button>
        <button onclick="closeWithdrawModal()" data-i18n-key="wd_modal_cancel">H·ªßy</button>
      </div>
    </div>

  </div>

  <script>
    // ===== D·ªØ li·ªáu i18n =====
    const locales = {
      vi: { /*... nh∆∞ tr√™n ...*/ },
      en: { /*... nh∆∞ tr√™n ...*/ }
    };
    function applyLocale(lang) {
      document.querySelectorAll('[data-i18n-key]').forEach(el=>{
        const key = el.getAttribute('data-i18n-key');
        el.textContent = locales[lang][key] || el.textContent;
      });
      document.title = locales[lang].title;
    }
    document.getElementById('langSelect').addEventListener('change', e=>{
      applyLocale(e.target.value);
    });

    // ===== ƒêƒÉng nh·∫≠p & Init =====
    const STORAGE_USER_KEY = 'smartmall_username';
    let currentUsername = '';
    document.addEventListener('DOMContentLoaded', ()=>{
      applyLocale('vi');
      const saved = localStorage.getItem(STORAGE_USER_KEY);
      if (saved) {
        currentUsername = saved;
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display   = 'block';
        initApp();
      }
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
    });
    function handleLogin(){
      const u = document.getElementById('usernameInput').value.trim();
      if (!u) return alert('Nh·∫≠p username!');
      currentUsername = u;
      localStorage.setItem(STORAGE_USER_KEY, u);
      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display   = 'block';
      initApp();
    }

    // ===== State chung =====
    const state = {
      usdtPrice: 26400,
      walletBalance: 100000,
      registrations: [],
      products: [],
      pendingSales: [],
      userNFT: [],
      walletHistory: [],
      requests: [],
      nftHistory: []
    };
    let selectedDate = '';

    // ===== Helpers =====
    function fmt(n){ return n.toLocaleString('vi-VN'); }
    function randomId(){
      const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let s=''; for(let i=0;i<18;i++) s+=c.charAt(Math.floor(Math.random()*c.length));
      return s;
    }
    function randomColor(){ return `hsl(${Math.random()*360|0},40%,30%)`; }
    function addWalletHistory(desc, delta){
      state.walletHistory.unshift({desc,delta,time:new Date().toLocaleString('vi-VN')});
      renderWalletHistory();
    }
    function showSection(id){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('show'));
      document.getElementById(id).classList.add('show');
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById('btn-'+id).classList.add('active');
    }
    function updateWallet(){
      document.getElementById('walletBalance').innerText = fmt(state.walletBalance);
    }

    // ===== Init App =====
    function initApp(){
      // t·∫°o sample products
      const names=['Tai nghe Bluetooth','Qu·∫°t mini USB','ƒê√®n c·∫£m ·ª©ng'];
      const prices=[50000,30000,45000];
      state.products = names.map((n,i)=>({
        id: randomId(), name: n, price: prices[i], seller: 'Admin'
      }));
      document.getElementById('profileUsername').innerText = currentUsername;
      generateTabs();
      updateWallet();
      renderProducts();
      renderPendingSales();
      renderNFTs();
      renderWalletHistory();
      renderRequestHistory();
      renderNFTHistory();
      // referral
      const bot='SmartMallonebot',
            start=new URLSearchParams(location.search).get('start')||'guest',
            link=`https://t.me/${bot}?start=${start}`;
      const a=document.getElementById('referralLink');
      a.href=link; a.innerText=link;
      showSection('home');
    }

    // ===== Session =====
    function generateTabs(){
      const c=document.getElementById('sessionDateTabs'),
            txt=document.getElementById('selectedDateText'),
            t=new Date();
      for(let i=0;i<7;i++){
        const d=new Date(t); d.setDate(d.getDate()+i);
        const lbl=`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
        const btn=document.createElement('button');
        btn.textContent=lbl;
        btn.onclick=()=>{
          c.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
          btn.classList.add('active');
          selectedDate=lbl; txt.textContent=lbl; updateSessionUI();
        };
        if(i===0){ btn.classList.add('active'); selectedDate=lbl; txt.textContent=lbl; }
        c.appendChild(btn);
      }
      updateSessionUI();
    }
    function updateSessionUI(){
      const reg=state.registrations.find(r=>r.date===selectedDate);
      document.getElementById('registrationBox').style.display = reg?'none':'block';
      document.getElementById('joinContainer').style.display   = reg?'block':'none';
      document.getElementById('products').style.display        = 'none';
    }
    function showRegisterModal(){
      if(state.walletBalance<20000) return alert('Kh√¥ng ƒë·ªß 20 000 SML');
      document.getElementById('registerModal').classList.add('show');
    }
    function closeRegisterModal(){
      document.getElementById('registerModal').classList.remove('show');
    }
    function confirmRegister(){
      state.walletBalance-=20000; updateWallet();
      addWalletHistory('Ph√≠ ƒëƒÉng k√Ω phi√™n', -20000);
      state.registrations.push({date:selectedDate,time:Date.now()});
      closeRegisterModal(); updateSessionUI();
      alert(`ƒê√£ ƒëƒÉng k√Ω phi√™n ${selectedDate}`);
    }
    function joinSession(){
      if(!state.registrations.find(r=>r.date===selectedDate)) return alert('Ch∆∞a ƒëƒÉng k√Ω phi√™n');
      document.getElementById('products').style.display='block';
      renderProducts(); renderPendingSales();
    }

    // ===== Products =====
    function renderProducts(){
      const c=document.getElementById('productList'); c.innerHTML='';
      state.products.forEach(p=>{
        const d=document.createElement('div');
        d.className='product'; d.style.background=randomColor();
        const info=document.createElement('div');
        info.innerHTML=`<b>${p.name}</b><br>ID:${p.id}<br>Gi√°:${fmt(p.price)} SML`;
        const btn=document.createElement('button');
        btn.className='small'; btn.textContent='Mua';
        btn.addEventListener('click', ()=> buyProduct(p.id));
        d.appendChild(info); d.appendChild(btn);
        c.appendChild(d);
      });
    }
    function buyProduct(id){
      const p=state.products.find(x=>x.id===id);
      if(!p) return alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
      state.userNFT.push({...p,status:'bought'});
      state.products=state.products.filter(x=>x.id!==id);
      state.nftHistory.unshift({
        id:p.id,name:p.name,price:p.price,
        time:new Date().toLocaleString('vi-VN'),action:'Mua'
      });
      renderProducts(); renderNFTs(); renderNFTHistory();
    }

    function renderPendingSales(){
      const c=document.getElementById('pendingSaleList'); c.innerHTML='';
      state.pendingSales.filter(s=>s.sellDate===selectedDate)
        .forEach(s=>{
          const d=document.createElement('div');
          d.className='sale-item'; d.style.background=randomColor();
          const info=document.createElement('div');
          info.innerHTML=`<b>${s.name}</b><br>ID:${s.id}<br>Gi√° g·ª≠i b√°n:${fmt(s.salePrice)} SML`;
          const btn=document.createElement('button');
          btn.className='small'; btn.textContent='Mua';
          btn.addEventListener('click', ()=> buyPendingSale(s.id));
          d.appendChild(info); d.appendChild(btn);
          c.appendChild(d);
        });
    }
    function buyPendingSale(id){
      const idx=state.pendingSales.findIndex(x=>x.id===id);
      if(idx<0) return;
      const s=state.pendingSales[idx];
      state.userNFT.push({...s,status:'bought'});
      state.pendingSales.splice(idx,1);
      state.nftHistory.unshift({
        id:s.id,name:s.name,price:s.salePrice,
        time:new Date().toLocaleString('vi-VN'),action:'Mua l·∫°i'
      });
      renderPendingSales(); renderNFTs(); renderNFTHistory();
    }

    // ===== NFT =====
    function renderNFTs(){
      const c=document.getElementById('nftList'); c.innerHTML=''; let tot=0;
      if(!state.userNFT.length){
        c.textContent='Ch∆∞a c√≥ s·∫£n ph·∫©m.'; document.getElementById('totalSpent').innerText='0'; return;
      }
      state.userNFT.forEach(it=>{
        tot+=it.price;
        const d=document.createElement('div');
        d.className='nft-item'; d.style.background=randomColor();
        let btns='';
        if(it.status==='bought'){
          btns=`<button class="small" onclick="confirmPayment('${it.id}')">Thanh to√°n ‚Äî ${fmt(it.price)} SML</button>`;
        } else if(it.status==='paid'){
          btns=`
            <button class="small" onclick="openNFT('${it.id}')">M·ªü (90%)</button>
            <button class="small" onclick="sellNFT('${it.id}')">B√°n</button>`;
        } else if(it.status==='opened'){
          btns=`<p>Ho√†n ${fmt(it.refund)} SML</p>`;
        } else if(it.status==='pendingSale'){
          btns=`<p>ƒêang treo b√°n: ${fmt(it.salePrice)} SML</p>`;
        }
        d.innerHTML=`<b>${it.name}</b><br>ID:${it.id}<br>${btns}`;
        c.appendChild(d);
      });
      document.getElementById('totalSpent').innerText=fmt(tot);
    }
    function confirmPayment(id){
      const it=state.userNFT.find(x=>x.id===id&&x.status==='bought');
      if(!it) return; if(state.walletBalance<it.price) return alert('Kh√¥ng ƒë·ªß SML');
      state.walletBalance-=it.price; updateWallet();
      addWalletHistory(`Thanh to√°n ${it.name}`,-it.price);
      it.status='paid';
      state.nftHistory.unshift({
        id:it.id,name:it.name,price:it.price,
        time:new Date().toLocaleString('vi-VN'),action:'Thanh to√°n'
      });
      renderNFTs(); renderNFTHistory();
    }
    function openNFT(id){
      const it=state.userNFT.find(x=>x.id===id&&x.status==='paid');
      const refund=Math.floor(it.price*0.9);
      state.walletBalance+=refund; updateWallet();
      addWalletHistory(`Ho√†n NFT ${it.name}`,+refund);
      it.status='opened'; it.refund=refund;
      state.nftHistory.unshift({
        id:it.id,name:it.name,price:refund,
        time:new Date().toLocaleString('vi-VN'),action:'M·ªü NFT'
      });
      renderNFTs(); renderNFTHistory();
    }
    function sellNFT(id){
      const it=state.userNFT.find(x=>x.id===id&&x.status==='paid');
      const profit=Math.floor(it.price*0.015), fee=Math.ceil(it.price*0.034),
            salePrice=it.price+profit+fee;
      if(state.walletBalance<fee) return alert('Kh√¥ng ƒë·ªß ph√≠');
      if(!confirm(`B√°n ${it.name}\nGi√° b√°n: ${fmt(salePrice)} SML?`)) return;
      state.walletBalance-=fee; updateWallet();
      addWalletHistory(`Ph√≠ b√°n ${it.name}`,-fee);
      it.status='pendingSale'; it.salePrice=salePrice; it.saleFee=fee;
      const d=new Date(); d.setDate(d.getDate()+1);
      it.sellDate=`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
      state.pendingSales.push({id:it.id,name:it.name,salePrice, saleFee:fee, sellDate:it.sellDate});
      state.nftHistory.unshift({
        id:it.id,name:it.name,price:salePrice,
        time:new Date().toLocaleString('vi-VN'),action:'G·ª≠i b√°n'
      });
      renderNFTs(); renderPendingSales(); renderNFTHistory();
    }

    // ===== V√≠ =====
    function showDeposit(){
      document.getElementById('depositModal').classList.add('show');
    }
    function closeDepositModal(){
      document.getElementById('depositModal').classList.remove('show');
    }
    document.getElementById('depositSML').addEventListener('input', e=>{
      const v=parseFloat(e.target.value)||0;
      document.getElementById('requiredUSDT').innerText=`C·∫ßn chuy·ªÉn: ${(v/state.usdtPrice).toFixed(4)} USDT`;
    });
    function submitDeposit(){
      const v=parseFloat(document.getElementById('depositSML').value);
      if(isNaN(v)||v<=0) return alert('Nh·∫≠p s·ªë h·ª£p l·ªá');
      const usdt=(v/state.usdtPrice).toFixed(4);
      state.requests.unshift({
        id:randomId(), type:'deposit', sml:v, usdt,
        address:document.getElementById('depositAddress').innerText,
        time:new Date().toLocaleString('vi-VN'), status:'pending'
      });
      renderRequestHistory();
      closeDepositModal();
      alert('Y√™u c·∫ßu n·∫°p ƒë√£ g·ª≠i, ch·ªù duy·ªát.');
    }
    function approveDeposit(id){
      const req=state.requests.find(r=>r.id===id&&r.type==='deposit');
      if(!req) return alert('Kh√¥ng t√¨m th·∫•y');
      if(req.status!=='pending') return alert('ƒê√£ x·ª≠ l√Ω');
      state.walletBalance+=req.sml; updateWallet();
      addWalletHistory('N·∫°p SML',+req.sml);
      req.status='approved'; renderRequestHistory();
      alert(`ƒê√£ duy·ªát n·∫°p ${fmt(req.sml)} SML`);
    }

    function showWithdraw(){
      document.getElementById('withdrawModal').classList.add('show');
    }
    function closeWithdrawModal(){
      document.getElementById('withdrawModal').classList.remove('show');
    }
    function submitWithdraw(){
      const v=parseFloat(document.getElementById('withdrawAmt').value);
      if(isNaN(v)||v<1000000) return alert('Min r√∫t l√† 1 000 000 SML');
      if(v>state.walletBalance) return alert('S·ªë d∆∞ kh√¥ng ƒë·ªß');
      state.requests.unshift({
        id:randomId(), type:'withdraw', sml:v, usdt:0,
        address:'', time:new Date().toLocaleString('vi-VN'), status:'pending'
      });
      renderRequestHistory();
      closeWithdrawModal();
      alert('Y√™u c·∫ßu r√∫t ƒë√£ g·ª≠i, ch·ªù duy·ªát.');
    }
    function approveWithdraw(id){
      const req=state.requests.find(r=>r.id===id&&r.type==='withdraw');
      if(!req) return alert('Kh√¥ng t√¨m th·∫•y');
      if(req.status!=='pending') return alert('ƒê√£ x·ª≠ l√Ω');
      state.walletBalance-=req.sml; updateWallet();
      addWalletHistory('R√∫t SML',-req.sml);
      req.status='approved'; renderRequestHistory();
      alert(`ƒê√£ duy·ªát r√∫t ${fmt(req.sml)} SML`);
    }

    function showTransfer(){
      document.getElementById('walletAction').innerHTML = `
        <h3>Chuy·ªÉn n·ªôi b·ªô</h3>
        <input id="transferTo" placeholder="ID th√†nh vi√™n"/>
        <input id="transferAmt" type="number" placeholder="S·ªë SML"/>
        <button onclick="submitTransfer()">Chuy·ªÉn</button>
      `;
    }
    function submitTransfer(){
      const to=document.getElementById('transferTo').value.trim(),
            amt=parseFloat(document.getElementById('transferAmt').value);
      if(!state.members?.includes(to)) return alert('ID kh√¥ng t·ªìn t·∫°i');
      if(isNaN(amt)||amt<=0||amt>state.walletBalance) return alert('S·ªë kh√¥ng h·ª£p l·ªá');
      state.walletBalance-=amt; updateWallet();
      addWalletHistory(`Chuy·ªÉn cho ${to}`,-amt);
      document.getElementById('walletAction').innerHTML='';
    }

    function renderWalletHistory(){
      const c=document.getElementById('walletHistory');
      if(!state.walletHistory.length){ c.textContent='Ch∆∞a c√≥ giao d·ªãch.'; return; }
      c.innerHTML=state.walletHistory.map(h=>{
        const cls=h.delta<0?'neg':'pos';
        return `<div>${h.time}: <span class="${cls}">${h.delta>0?'+':''}${fmt(h.delta)}</span> ‚Äì ${h.desc}</div>`;
      }).join('');
    }
    function renderRequestHistory(){
      document.getElementById('requestHistory').innerHTML =
        state.requests.map(r=>`
          <tr>
            <td>${r.type}</td>
            <td>${fmt(r.sml)}</td>
            <td>${r.usdt||''}</td>
            <td>${r.address||''}</td>
            <td>${r.time}</td>
            <td>${r.status}</td>
          </tr>`).join('');
    }
    function renderNFTHistory(){
      const ul=document.getElementById('nftHistory');
      if(!state.nftHistory.length){ ul.textContent='Ch∆∞a c√≥ l·ªãch s·ª≠.'; return; }
      ul.innerHTML=state.nftHistory.map(x=>
        `<li>${x.time}: [${x.action}] ${x.name} ‚Äî ${fmt(x.price)} SML</li>`
      ).join('');
    }

    function saveProfile(){ alert('Th√¥ng tin ƒë√£ l∆∞u.'); }
  </script>
</body>
</html>
