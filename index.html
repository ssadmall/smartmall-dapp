<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Mall DApp</title>
  <style>
    body { background:#0a1a2f; color:#fff; font-family:Arial, sans-serif; margin:0; padding-bottom:100px; }
    section { display:none; padding:20px; margin:10px; background:#162447; border:2px solid #21e6c1; border-radius:8px; }
    section.active { display:block; }
    h2 { margin-top:0; color:#21e6c1; }
    button, input { border:none; border-radius:4px; }
    button { background:#21e6c1; color:#0a1a2c; font-weight:bold; cursor:pointer; margin:6px 0; padding:8px; width:100%; }
    button.small { display:inline-block; width:auto; margin:4px 2px; padding:6px 12px; }
    input { width:100%; padding:8px; margin:6px 0; background:#1f4068; color:#fff; }
    .date-tab-bar { display:flex; justify-content:space-between; background:#1b2c45; padding:6px; border-radius:8px; margin:12px 0; }
    .date-tab-bar button { flex:1; margin:0 2px; padding:6px 4px; background:#0f1c2e; color:#ccc; font-size:13px; cursor:pointer; }
    .date-tab-bar button.active { background:#21e6c1; color:#162447; font-weight:bold; }
    .product, .nft-item, .sale-item { background:#1f4068; border:1px solid #21e6c1; border-radius:6px; padding:10px; margin-bottom:10px; }
    .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-content { background:#fff; color:#000; padding:20px; border-radius:8px; width:300px; }
    #walletAction { margin-top:10px; }
    #walletHistory { margin-top:20px; max-height:200px; overflow-y:auto; }
    #walletHistory div { padding:6px 0; font-size:14px; }
    .pos { color:#4caf50; } .neg { color:#f44336; }
    nav { position:fixed; bottom:0; left:0; right:0; display:flex; background:#162447; border-top:2px solid #21e6c1; z-index:999; }
    nav button { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0; font-size:14px; line-height:1.2; background:#162447; color:#fff; cursor:pointer; }
    nav button .nav-icon { font-size:20px; margin-bottom:2px; }
    nav button.active, nav button:hover { background:#21e6c1; color:#162447; }
    #referralSection a { word-break:break-all; color:#ffcc00; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #21e6c1; padding:6px; text-align:left; font-size:14px; }
    th { background:#1b2c45; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

  <!-- HOME -->
  <section id="home" class="active">
    <h2>ğŸ“¢ ThÃ´ng bÃ¡o tá»« Admin</h2>
    <p>ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i Smart Mall - Giao dá»‹ch thÃ´ng minh, cá»™ng Ä‘á»“ng bá»n vá»¯ng!</p>
  </section>

  <!-- SESSION -->
  <section id="session">
    <h2>ğŸ•’ PhiÃªn giao dá»‹ch</h2>
    <div class="date-tab-bar" id="sessionDateTabs"></div>
    <p>NgÃ y phiÃªn Ä‘Ã£ chá»n: <b id="selectedDateText"></b></p>
    <div id="registrationBox"><button id="registerBtn" onclick="showRegisterModal()">ÄÄƒng kÃ½ phiÃªn</button></div>
    <div id="joinContainer" style="display:none"><button id="joinBtn" class="small" onclick="joinSession()">Tham gia phiÃªn</button></div>
    <div id="products" style="display:none">
      <h3>Sáº£n pháº©m phiÃªn hÃ´m nay</h3><div id="productList"></div>
      <h3>Sáº£n pháº©m treo bÃ¡n</h3><div id="pendingSaleList"></div>
    </div>
  </section>

  <!-- NFT -->
  <section id="nft">
    <h2>ğŸ§¾ NFT cá»§a tÃ´i</h2>
    <div id="nftList"></div>
    <p>Tá»•ng chi tiÃªu: <span id="totalSpent">0</span> USDT</p>
  </section>

  <!-- WALLET -->
  <section id="wallet">
    <h2>ğŸ’° VÃ­ SML</h2>
    <p>Sá»‘ dÆ°: <span id="walletBalance">100000</span> SML</p>
    <button onclick="showDeposit()">Náº¡p</button>
    <button onclick="showTransfer()">Chuyá»ƒn</button>
    <button onclick="showWithdraw()">RÃºt</button>
    <div id="walletAction"></div>
    <h3>Lá»‹ch sá»­ SML</h3><div id="walletHistory">ChÆ°a cÃ³ giao dá»‹ch</div>
  </section>

  <!-- PROFILE -->
  <section id="profile">
    <h2>ğŸ‘¤ ThÃ´ng tin cÃ¡ nhÃ¢n</h2>
    <input id="username" placeholder="TÃªn (viáº¿t liá»n)"/>
    <input id="phone" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i"/>
    <input id="fullname" placeholder="Há» tÃªn Ä‘áº§y Ä‘á»§"/>
    <input id="bep20" placeholder="Äá»‹a chá»‰ vÃ­ BEP20"/>
    <button onclick="saveProfile()">LÆ°u thÃ´ng tin</button>

    <!-- REFERRAL -->
    <div id="referralSection" style="margin-top:20px;padding-top:10px;border-top:1px solid #21e6c1;">
      <h3>ğŸ”— Link giá»›i thiá»‡u</h3>
      <p><a href="#" id="referralLink" target="_blank"></a></p>
      <p>ğŸ‘¥ Giá»›i thiá»‡u trá»±c tiáº¿p: <span id="directRefCount">0</span></p>
      <p>ğŸŒ Äá»™i nhÃ³m: <span id="teamRefCount">0</span></p>
    </div>
  </section>

  <!-- ADMIN PANEL -->
  <section id="admin" style="display:none">
    <h2>ğŸ‘‘ Admin Panel</h2>
    <p>Danh sÃ¡ch thÃ nh viÃªn Ä‘Ã£ Ä‘Äƒng kÃ½:</p>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Username</th><th>SML hiá»‡n cÃ³</th>
          <th>NgÃ y Ä‘Äƒng kÃ½</th><th>ÄÃ£ mua</th><th>Giá»›i thiá»‡u trá»±c tiáº¿p</th><th>Äá»™i nhÃ³m</th>
        </tr>
      </thead>
      <tbody id="adminMemberList"></tbody>
    </table>
  </section>

  <!-- REGISTER MODAL -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <h3>PhÃ­ Ä‘Äƒng kÃ½: 20 000 SML</h3>
      <input type="number" id="registerAmount" placeholder="Sá»‘ tiá»n dá»± kiáº¿n mua"/>
      <button onclick="confirmRegister()">XÃ¡c nháº­n</button>
      <button onclick="closeRegisterModal()">Há»§y</button>
    </div>
  </div>

  <!-- NAV BAR -->
  <nav>
    <button id="btn-home"    class="active" onclick="showSection('home')"><span class="nav-icon">ğŸ </span><span>Trang chá»§</span></button>
    <button id="btn-session" onclick="showSection('session')"><span class="nav-icon">ğŸ•’</span><span>PhiÃªn</span></button>
    <button id="btn-nft"     onclick="showSection('nft')"><span class="nav-icon">ğŸ§¾</span><span>NFT</span></button>
    <button id="btn-wallet"  onclick="showSection('wallet')"><span class="nav-icon">ğŸ’°</span><span>VÃ­</span></button>
    <button id="btn-profile" onclick="showSection('profile')"><span class="nav-icon">ğŸ‘¤</span><span>ThÃ´ng tin</span></button>
    <button id="btn-admin"   onclick="showSection('admin')" style="display:none"><span class="nav-icon">ğŸ› ï¸</span><span>Admin</span></button>
  </nav>

  <script>
    // Telegram WebApp & referral
    let tg, userId='guest';
    if (window.Telegram?.WebApp) {
      tg = Telegram.WebApp; tg.ready();
      userId = tg.initDataUnsafe?.user?.id ?? 'guest';
    }
    const botUsername='SmartMallonebot';
    const referralParam=new URLSearchParams(location.search).get('start')||'guest';
    // State
    const adminID='7980638669';
    let walletBalance=100000, registerFee=20000, registeredFee=false;
    let selectedDate=null, totalSpent=0;
    let products=[ 
      {id:'012345678901234567890123',name:'Tai nghe Bluetooth',price:50000,seller:'Admin'},
      {id:'123456789012345678901234',name:'Quáº¡t mini USB',price:30000,seller:'Admin'},
      {id:'234567890123456789012345',name:'ÄÃ¨n há»c cáº£m á»©ng',price:45000,seller:'Admin'}
    ];
    let userNFT=[], pendingSales=[], walletHistory=[], members=[];
    // Utils
    function fmt(n){return n.toLocaleString('vi-VN');}
    function updateWallet(){document.getElementById('walletBalance').innerText=fmt(walletBalance);}
    function addHistory(desc,delta){
      walletHistory.unshift({desc,delta,time:new Date().toLocaleString('vi-VN')});
      renderHistory();
    }
    function renderHistory(){
      const h=document.getElementById('walletHistory');
      if(!walletHistory.length) return h.innerText='ChÆ°a cÃ³ giao dá»‹ch';
      h.innerHTML=walletHistory.map(x=>
        `<div>[${x.time}] <span class="${x.delta<0?'neg':'pos'}">
           ${x.delta>0?'+':''}${fmt(Math.abs(x.delta))}
         </span> SML â€“ ${x.desc}</div>`
      ).join('');
    }
    function showSection(id){
      document.querySelectorAll('section').forEach(s=>s.style.display='none');
      document.getElementById(id).style.display='block';
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
      document.getElementById('btn-'+id).classList.add('active');
    }
    // Tabs
    function generateTabs(){
      const c=document.getElementById('sessionDateTabs'),
            txt=document.getElementById('selectedDateText'),
            today=new Date();
      for(let i=0;i<7;i++){
        const d=new Date(today); d.setDate(d.getDate()+i);
        const lbl=`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
        const btn=document.createElement('button'); btn.textContent=lbl;
        btn.onclick=()=>{
          document.querySelectorAll('.date-tab-bar button').forEach(x=>x.classList.remove('active'));
          btn.classList.add('active'); selectedDate=lbl; txt.innerText=lbl;
        };
        if(i===0){btn.classList.add('active'); selectedDate=lbl; txt.innerText=lbl;}
        c.appendChild(btn);
      }
    }
    // Profile save
    function saveProfile(){ alert('ThÃ´ng tin cÃ¡ nhÃ¢n Ä‘Ã£ lÆ°u.'); }
    // Register
    function showRegisterModal(){
      if(walletBalance<registerFee) return alert('KhÃ´ng Ä‘á»§ SML!');
      document.getElementById('registerModal').style.display='flex';
    }
    function closeRegisterModal(){
      document.getElementById('registerModal').style.display='none';
    }
    function confirmRegister(){
      const amt=parseFloat(document.getElementById('registerAmount').value);
      if(isNaN(amt)||amt<=0) return alert('Nháº­p sá»‘ tiá»n há»£p lá»‡!');
      // deduct fee
      walletBalance-=registerFee; updateWallet(); addHistory('PhÃ­ Ä‘Äƒng kÃ½ phiÃªn',-registerFee);
      registeredFee=true; closeRegisterModal();
      document.getElementById('registrationBox').innerHTML=`<p>ÄÃ£ Ä‘Äƒng kÃ½: ${fmt(amt)}</p>`;
      document.getElementById('joinContainer').style.display='block';
      // record member
      const username=document.getElementById('username').value.trim()||userId;
      const regDate=new Date().toLocaleString('vi-VN');
      members.push({id:userId,username,balance:walletBalance,registerDate:regDate,purchasedCount:0,directRefCount:0,teamRefCount:0});
      // referral
      if(referralParam!=='guest' && referralParam!==userId){
        const ref=members.find(m=>m.id===referralParam);
        if(ref){ref.directRefCount++;ref.teamRefCount++;}
      }
    }
    // Join session
    function joinSession(){
      if(registeredFee){
        walletBalance+=registerFee; updateWallet(); addHistory('HoÃ n phÃ­ Ä‘Äƒng kÃ½',+registerFee);
        registeredFee=false;
      }
      document.getElementById('products').style.display='block';
      renderProducts(); renderPendingSales();
    }
    // Products
    function renderProducts(){
      const c=document.getElementById('productList'); c.innerHTML='';
      products.forEach(p=>{
        c.innerHTML+=`<div class="product"><b>${p.name}</b><br>ID: ${p.id}<br>GiÃ¡: ${fmt(p.price)}<br>
          <button class="small" onclick="buyProduct('${p.id}')">Mua</button></div>`;
      });
    }
    function buyProduct(id){
      const p=products.find(x=>x.id===id); if(!p)return;
      userNFT.push({...p,status:'bought'});
      products=products.filter(x=>x.id!==id);
      // increment purchasedCount for this member
      const mem=members.find(m=>m.id===userId);
      if(mem) mem.purchasedCount++;
      renderProducts(); renderNFTs();
    }
    // Pending sales
    function renderPendingSales(){
      const c=document.getElementById('pendingSaleList'); c.innerHTML='';
      if(!selectedDate) return;
      pendingSales.filter(s=>s.sellDate===selectedDate).forEach(s=>{
        c.innerHTML+=`<div class="sale-item"><b>${s.name}</b><br>ID:${s.id}<br>
          GiÃ¡ bÃ¡n:${fmt(s.salePrice)}<br>PhÃ­:${fmt(s.saleFee)}<br>
          <button class="small" onclick="buyPendingSale('${s.id}')">Mua</button></div>`;
      });
    }
    function buyPendingSale(id){
      const idx=pendingSales.findIndex(x=>x.id===id); if(idx<0)return;
      const s=pendingSales[idx];
      if(walletBalance<s.salePrice)return alert('KhÃ´ng Ä‘á»§ SML!');
      walletBalance-=s.salePrice; updateWallet(); addHistory(`Mua ${s.name}`,-s.salePrice);
      userNFT.push({...s,status:'bought'}); pendingSales.splice(idx,1);
      const mem=members.find(m=>m.id===userId); if(mem) mem.purchasedCount++;
      renderPendingSales(); renderNFTs();
    }
    // NFT
    function renderNFTs(){
      const c=document.getElementById('nftList'); c.innerHTML=''; let tot=0;
      if(!userNFT.length) return c.innerText='ChÆ°a cÃ³ sáº£n pháº©m.';
      userNFT.forEach(it=>{
        tot+=it.price;
        let html=`<div class="nft-item"><b>${it.name}</b><br>ID:${it.id}<br>`;
        if(it.status==='bought') html+=`<button class="small" onclick="markPaid('${it.id}')">ÄÃ£ thanh toÃ¡n</button>`;
        else if(it.status==='owned') html+=`<button class="small" onclick="openNFT('${it.id}')">Má»Ÿ</button>
          <button class="small" onclick="sellNFT('${it.id}')">BÃ¡n</button>`;
        html+='</div>';
        c.innerHTML+=html;
      });
      document.getElementById('totalSpent').innerText=fmt(tot);
    }
    function markPaid(id){
      const it=userNFT.find(x=>x.id===id); if(!it||walletBalance<it.price)return alert('KhÃ´ng Ä‘á»§ SML!');
      walletBalance-=it.price; updateWallet(); addHistory('Thanh toÃ¡n',-it.price);
      it.status='owned'; renderNFTs();
    }
    function openNFT(id){
      const it=userNFT.find(x=>x.id===id); if(!it)return;
      const rf=it.price*0.9; walletBalance+=rf; updateWallet(); addHistory('HoÃ n NFT',rf);
      it.status='opened'; renderNFTs(); alert(`Báº¡n nháº­n ${fmt(rf)} SML`);
    }
    function sellNFT(id){
      const it=userNFT.find(x=>x.id===id); if(!it)return;
      const profit=it.price*0.015, fee=it.price*0.034, salePrice=it.price+profit+fee;
      if(walletBalance<fee)return alert('KhÃ´ng Ä‘á»§ SML tráº£ phÃ­!');
      walletBalance-=fee; updateWallet(); addHistory('PhÃ­ gá»­i bÃ¡n',-fee);
      it.status='pendingSale'; it.salePrice=salePrice;
      const tm=new Date(); tm.setDate(tm.getDate()+1);
      it.sellDate=new Intl.DateTimeFormat('vi-VN',{day:'2-digit',month:'2-digit'}).format(tm);
      pendingSales.push({...it}); renderNFTs(); renderPendingSales();
    }
    // Wallet
    function showDeposit(){ document.getElementById('walletAction').innerHTML=`
      <h3>Náº¡p SML</h3><input type="number" id="depositAmt" placeholder="Sá»‘ SML"/>
      <button onclick="confirmDeposit()">XÃ¡c nháº­n</button>`; }
    function confirmDeposit(){ const amt=parseFloat(document.getElementById('depositAmt').value);
      if(isNaN(amt)||amt<=0)return alert('Nháº­p sá»‘ há»£p lá»‡!'); walletBalance+=amt; updateWallet(); addHistory('Náº¡p SML',amt);
      document.getElementById('walletAction').innerHTML=''; }
    function showTransfer(){ document.getElementById('walletAction').innerHTML=`
      <h3>Chuyá»ƒn SML</h3><input id="transferTo" placeholder="NgÆ°á»i nháº­n"/>
      <input id="transferAmt" placeholder="Sá»‘ SML"/><button onclick="confirmTransfer()">XÃ¡c nháº­n</button>`;}
    function confirmTransfer(){ const to=document.getElementById('transferTo').value.trim(),
            amt=parseFloat(document.getElementById('transferAmt').value);
      if(!to||isNaN(amt)||amt<=0)return alert('Nháº­p Ä‘Ãºng thÃ´ng tin!'); if(walletBalance<amt)return alert('KhÃ´ng Ä‘á»§ SML!');
      walletBalance-=amt; updateWallet(); addHistory(`Chuyá»ƒn cho ${to}`,-amt); document.getElementById('walletAction').innerHTML=''; }
    function showWithdraw(){ document.getElementById('walletAction').innerHTML=`
      <h3>RÃºt SML</h3><input id="withdrawAddr" placeholder="Äá»‹a chá»‰ BEP20"/><input id="withdrawAmt" placeholder="Sá»‘ SML"/>
      <p>PhÃ­ 1.5%</p><button onclick="confirmWithdraw()">XÃ¡c nháº­n</button>`;}
    function confirmWithdraw(){ const addr=document.getElementById('withdrawAddr').value.trim(),
            amt=parseFloat(document.getElementById('withdrawAmt').value);
      if(!addr||isNaN(amt)||amt<=0)return alert('Nháº­p Ä‘Ãºng thÃ´ng tin!');
      const fee=amt*0.015, total=amt+fee; if(walletBalance<total)return alert('KhÃ´ng Ä‘á»§ SML!');
      walletBalance-=total; updateWallet(); addHistory(`RÃºt ${fmt(amt)} (+ phÃ­ ${fmt(fee)})`,-total);
      document.getElementById('walletAction').innerHTML=''; }
    // Admin render
    function renderAdminPanel(){
      const tbody=document.getElementById('adminMemberList'); tbody.innerHTML='';
      members.forEach(m=>{
        tbody.innerHTML+=`<tr>
          <td>${m.id}</td><td>${m.username}</td><td>${fmt(m.balance)}</td>
          <td>${m.registerDate}</td><td>${m.purchasedCount}</td>
          <td>${m.directRefCount}</td><td>${m.teamRefCount}</td>
        </tr>`;
      });
    }
    // Init
    window.onload=()=>{
      generateTabs(); updateWallet(); renderHistory(); renderProducts();
      // Referral link
      document.getElementById('referralLink').href=referralLink;
      document.getElementById('referralLink').innerText=referralLink;
      // Show admin if match
      if(userId===adminID){
        document.getElementById('btn-admin').style.display='flex';
      }
    };
  </script>
</body>
</html>
